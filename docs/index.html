<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="utf-8">
	<title>Sah State</title>
	<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
	
	<style>
		body { margin: 0; font-family: sans-serif; }
		#cy {
			width: 100vw;
			height: 100vh;
			display: inline-block;
		}
	</style>
</head>

<body>
<div id="cy"></div>

<script>
	// ---------------------
	// Elements
	// ---------------------
	const elements = [
		// # Nodes
		// UI
		{ data: { id: 'sah-web-ui', label: 'sah-web-ui', type: 'UI', status: 'live' }},

		// Auth
		{ data: { id: 'cognito', label: 'Cognito Auth', type: 'auth', status: 'live' }},


		// AgentCore
		{ data: { id: 'sah', label: 'SAH', type: 'agent', status: 'live' }},
		{ data: { id: 'career-agent', label: 'Career Sub-Agent', type: 'sub-agent', status: 'live' }},
		{ data: { id: 'financials-agent', label: 'Financials Sub-Agent', type: 'sub-agent', status: 'live' }},
		{ data: { id: 'wellness-agent', label: 'Wellness Sub-Agent', type: 'sub-agent', status: 'in-development' }},
		{ data: { id: 'entertainment-agent', label: 'Entertainment Sub-Agent', type: 'sub-agent', status: 'in-development' }},
		{ data: { id: 'shopping-agent', label: 'Shopping Sub-Agent', type: 'sub-agent', status: 'in-development' }},

		// Lambdas
		{ data: { id: 'conversation-mgr', label: 'conversation-mgr', type: 'lambda', status: 'live' }},
		{ data: { id: 'sah-conversation-summarizer', label: 'summarizer', type: 'lambda', status: 'live' }},
		{ data: { id: 'sah-income-expense-tracker', label: 'income-expense', type: 'lambda', status: 'live' }},

		// App Runner
		{ data: { id: 'agent-py-tools', label: 'agent-py-tools (py container)', type: 'container', status: 'live' }},
		{ data: { id: 'resume_builder', label: 'resume_builder', type: 'tool', status: 'live' }},
		{ data: { id: 'messaging_email', label: 'messaging_email', type: 'tool', status: 'live' }},

		// EC2
		{ data: { id: 'sah-mcp', label: 'SAH MCP Server', type: 'mcp-server', status: 'live' }},
		
		// # Edges

		// UI Relationships
		{ data: { source: 'sah-web-ui', target: 'cognito', label: 'auth' }},
		
		{ data: { source: 'sah-web-ui', target: 'sah', label: 'send user messages' }},
		{ data: { source: 'sah-web-ui', target: 'conversation-mgr', label: 'REST' }},
		

		// Agent Relationships
		{ data: { source: 'sah', target: 'career-agent' }},
		{ data: { source: 'sah', target: 'financials-agent' }},
		{ data: { source: 'sah', target: 'wellness-agent' }},
		{ data: { source: 'sah', target: 'entertainment-agent' }},
		{ data: { source: 'sah', target: 'shopping-agent' }},
		{ data: { source: 'sah', target: 'sah-mcp' }},

		{ data: { source: 'career-agent', target: 'sah-mcp' }},
		{ data: { source: 'financials-agent', target: 'sah-mcp' }},
		{ data: { source: 'wellness-agent', target: 'sah-mcp' }},
		{ data: { source: 'entertainment-agent', target: 'sah-mcp' }},
		{ data: { source: 'shopping-agent', target: 'sah-mcp' }},

		// MCP Server to lambdas or service tools relationships
		{ data: { source: 'sah-mcp', target: 'sah-conversation-summarizer', label: 'invoke lambda' }},
		{ data: { source: 'sah-mcp', target: 'sah-income-expense-tracker', label: 'invoke lambda' }},
		{ data: { source: 'sah-mcp', target: 'agent-py-tools', label: 'invoke app runner' }},
		
		// Lambda to tool relationships
		{ data: { source: 'agent-py-tools', target: 'resume_builder', label: 'contains tool' }},
		{ data: { source: 'agent-py-tools', target: 'messaging_email', label: 'contains tool' }},
	];
	
	
	// -------------------------
	// Load starter positions
	// -------------------------
	const defaultPositions = {"sah-web-ui":{"x":-248.66956360066075,"y":98.88425133968758},"cognito":{"x":-246.79712174335722,"y":-7.67374230056024},"sah":{"x":-101.61318169867893,"y":93.06088996266645},"career-agent":{"x":117.47382895788442,"y":91.53962752038849},"financials-agent":{"x":20.152143714718292,"y":91.74585956814403},"wellness-agent":{"x":211.97823909264307,"y":299.00742816293644},"entertainment-agent":{"x":213.15554278450574,"y":217.3033856669101},"shopping-agent":{"x":193.88479377608354,"y":138.85976548499121},"conversation-mgr":{"x":-365.17338985541386,"y":97.98180516780998},"sah-conversation-summarizer":{"x":-84.53055467449497,"y":341.92295712268},"sah-income-expense-tracker":{"x":12.327881439372344,"y":366.9483138725902},"agent-py-tools":{"x":-207.19827785644648,"y":274.644508295567},"resume_builder":{"x":-333.3093595394234,"y":377.3645891241163},"messaging_email":{"x":-333.1107860832195,"y":279.5835989158654},"sah-mcp":{"x":18.149684871447274,"y":240.33393744694848}}

	const savedPositions = JSON.parse(localStorage.getItem("cyPositions") || JSON.stringify(defaultPositions));
	
	// Apply preset positions if found
	const elementsWithPositions = elements.map(el => {
		if (savedPositions[el.data?.id]) {
			return {
				...el,
				position: savedPositions[el.data.id]
			};
		}
		return el;
	});
	
	// -------------------------
	// Initialize Cytoscape
	// -------------------------
	const cy = cytoscape({
		container: document.getElementById('cy'),
		
		elements: elementsWithPositions,
		
		layout: Object.keys(savedPositions).length > 0
				? { name: "preset" }
				: { name: "cose", animate: true },
		
		style: [
			{
				selector: 'node',
				style: {
					'background-color': ele => {
						const colors = {
							'UI': '#6A1B9A',          // dark purple
							'agent': '#1E88E5',       // medium blue
							'sub-agent': '#90CAF9',   // light blue
							'lambda': '#00897B',      // teal
							'tool': '#EF6C00',        // orange
							'auth': '#C62828',        // red
							'mcp-server': '#4527A0',  // deep indigo
							'container': '#122f62'    // new color (amber)
						};
						return colors[ele.data('type')] || '#777';
					},

					// Border based on status
					'border-color': ele => {
						const status = ele.data('status');
						if (status === 'live') return '#2ECC71';
						if (status === 'in-development') return 'orange';
						if (status === 'planned') return '#3498DB';
						return '#555';
					},
					'border-width': 3,
					'border-style': 'double',

					// ADA-compliant text color selection
					'color': ele => {
						const bg = ele.style('background-color');
						const hex = bg.replace('#', '');
						const r = parseInt(hex.substring(0, 2), 16);
						const g = parseInt(hex.substring(2, 4), 16);
						const b = parseInt(hex.substring(4, 6), 16);
						const luminance = (0.299*r + 0.587*g + 0.114*b) / 255;
						return luminance > 0.5 ? 'black' : 'white';
					},

					// Label
					'label': 'data(label)',
					'font-size': '7px',
					'font-weight': 'bold',
					
					// Text wrapping and multiline support
					'text-wrap': 'wrap',
					'text-max-width': '50px',
					
					'text-valign': 'center',
					'text-halign': 'center',
					
					// Node size
					'width': 65,
					'height': 65,
					
					// Shape by type
					'shape': ele => {
						if (ele.data('type') === 'tool') return 'round-rectangle';
						if (ele.data('type') === 'lambda') return 'hexagon';
						if (ele.data('type') === 'container') return 'rectangle';
						return 'ellipse';
					}
				}
			},
			
			{
				selector: 'edge',
				style: {
					'line-color': 'lightblue',
					'width': 1,
					'curve-style': 'bezier',
					'target-arrow-shape': 'triangle',
					'target-arrow-color': '#ccc',
					'font-size': '6px',
					'text-background-opacity': 0.7,
					'text-background-color': '#ffffff',
					'text-background-padding': '2px',
					'label': 'data(label)'
				}
			}
		]
	});
	
	
	// -------------------------
	// Save positions on drag
	// -------------------------
	cy.on('dragfree', 'node', () => {
		const positions = {};
		cy.nodes().forEach(node => {
			positions[node.id()] = node.position();
		});
		localStorage.setItem("cyPositions", JSON.stringify(positions));
	});

</script>
</body>
</html>
